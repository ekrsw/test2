# ナレッジメンテナンスサイト - システム仕様書

## 1. システム概要

### 1.1 プロジェクト概要
- **システム名**: ナレッジメンテナンスサイト
- **目的**: Dynamics365ナレッジベースの品質向上を目的とした修正案・削除案の提出・承認・集計システム
- **対象規模**: 約100名
- **開発期間**: 未定（要相談）

### 1.2 システム構成
- **アーキテクチャ**: Webアプリケーション（3層構造）
- **プレゼンテーション層**: レスポンシブWebUI
- **アプリケーション層**: ビジネスロジック処理
- **データアクセス層**: PostgreSQLデータベース
- **外部連携**: Microsoft Dynamics365 (参照のみ)

## 2. 機能仕様

### 2.1 認証・認可機能

#### 2.1.1 ログイン機能
- **ユーザー名・パスワード認証**
  - 入力フィールド: ユーザー名、パスワード
  - バリデーション: 必須入力チェック
  - セッション管理: JWT Token (有効期限2時間)
  - ログイン失敗時: エラーメッセージ表示

#### 2.1.2 ユーザー役割管理
- **一般ユーザー**
  - 提案作成（修正案・削除案）
  - 自分の提案一覧表示・編集
  - 個人統計表示

- **SV（Supervisor）**
  - 一般ユーザー機能 + 承認機能
  - 担当グループの提案承認・却下
  - 承認待ち一覧表示
  - 承認詳細確認（修正前後比較）

- **管理者**
  - 全ユーザー機能 + 管理機能
  - 全体統計・レポート表示
  - ユーザー管理
  - システム設定

#### 2.1.3 セッション管理
- **セッション有効期限**: 2時間
- **自動ログアウト**: 有効期限切れ時
- **セッション延長**: アクティブ操作時に自動更新

### 2.2 記事管理機能

#### 2.2.1 記事検索機能
- **検索条件**
  - 記事番号（部分一致）
  - タイトル（部分一致）
  - カテゴリ（完全一致）

- **検索結果表示**
  - 一覧形式での表示（ページング：20件/ページ）
  - 表示項目: 記事番号、タイトル、カテゴリ、承認グループ、最終更新日
  - ソート機能: 最終更新日（降順）

#### 2.2.2 記事詳細表示
- **Dynamics365連携**
  - REST API経由での記事情報取得
  - リアルタイム情報表示
  - エラーハンドリング（API接続失敗時）

#### 2.2.3 記事選択機能
- **選択インターフェース**
  - チェックボックスによる記事選択
  - 選択状態のハイライト表示
  - 選択記事の基本情報表示

### 2.3 提案管理機能

#### 2.3.1 修正案作成機能

**入力フィールド**
- タイトル（必須、最大500文字）
- 情報カテゴリ（選択必須）
- キーワード（任意、カンマ区切り）
- 重要度フラグ（チェックボックス）
- 公開期間（開始日・終了日）
- 対象（ラジオボタン: 社内向け/社外向け/該当なし）
- 質問（任意、テキストエリア）
- 回答（任意、テキストエリア）
- 追加コメント（任意）
- 提案理由（必須、テキストエリア）

**バリデーション**
- 必須項目チェック
- 文字数制限チェック
- 日付妥当性チェック（開始日 ≤ 終了日）
- HTMLタグエスケープ処理

**保存処理**
1. 現在のDynamics365データを取得
2. ProposalsBeforeテーブルに修正前データ保存
3. Proposalsテーブルに修正後データ保存
4. 承認グループIDの自動設定

#### 2.3.2 削除案作成機能

**入力フィールド**
- 削除理由（必須、テキストエリア）

**処理フロー**
1. 対象記事の現在データを取得
2. ProposalsBeforeテーブルに削除対象データ保存
3. Proposalsテーブルに参考情報として現在データ保存
4. typeを'削除'に設定

#### 2.3.3 提案編集機能
- **編集可能条件**: status = '申請中'
- **編集不可条件**: 承認済み・却下済みの提案
- **下書き保存**: 入力途中での一時保存機能

#### 2.3.4 提案一覧表示
- **表示項目**: 記事タイトル、提案タイプ、状況、申請日、承認日
- **フィルタ機能**: 状況別、期間別、タイプ別
- **ソート機能**: 申請日（降順）、承認日
- **ページング**: 20件/ページ

### 2.4 承認機能

#### 2.4.1 承認待ち一覧（SV用）
- **表示条件**: 自分の担当グループの申請中提案
- **表示項目**: 提案者、記事タイトル、提案タイプ、申請日、経過日数
- **優先表示**: 申請日が古いものから順番
- **急ぎ案件**: 3日以上経過した案件をハイライト

#### 2.4.2 承認詳細確認
- **基本情報表示**
  - 提案者、申請日、記事情報、提案理由

- **修正前後比較表示（修正案の場合）**
  - 左右分割レイアウト
  - 修正前（赤背景）、修正後（緑背景）
  - 差分箇所のハイライト
  - フィールド別比較表示

- **削除対象確認（削除案の場合）**
  - 削除予定内容の表示
  - 削除理由の確認

#### 2.4.3 承認・却下処理
- **承認処理**
  - 承認ボタンクリック
  - 承認コメント入力（任意）
  - statusを'承認済み'に更新
  - approved_by, approved_atを設定

- **却下処理**
  - 却下ボタンクリック
  - 却下理由入力（必須）
  - statusを'却下'に更新
  - rejection_reasonを設定

### 2.5 集計・レポート機能

#### 2.5.1 個人統計（全ユーザー）
- **月次統計**
  - 当月提案数、承認数、却下数
  - 承認率（承認数/提案数）
  - 前月比較

- **期間別統計**
  - 四半期統計、年次統計
  - 期間指定による任意集計
  - グラフ表示（棒グラフ、円グラフ）

- **提案種別統計**
  - 修正案・削除案別の集計
  - カテゴリ別提案数

#### 2.5.2 全体統計（管理者用）
- **組織統計**
  - 部署別、グループ別提案数
  - ユーザー別ランキング
  - 承認率ランキング

- **システム統計**
  - 月次提案推移
  - カテゴリ別提案傾向
  - 平均承認時間

- **エクスポート機能**
  - CSV形式でのデータ出力
  - 期間指定、条件指定によるフィルタリング

## 3. API仕様

### 3.1 認証API

#### POST /api/auth/login
**リクエスト**
```json
{
  "username": "string",
  "password": "string"
}
```

**レスポンス**
```json
{
  "success": true,
  "data": {
    "token": "jwt_token",
    "user": {
      "id": "uuid",
      "username": "string",
      "role": "string",
      "group_id": "uuid"
    }
  }
}
```

#### POST /api/auth/logout
**リクエスト**
```json
{
  "token": "jwt_token"
}
```

### 3.2 記事API

#### GET /api/articles/search
**パラメータ**
- `article_id`: 記事番号（任意）
- `title`: タイトル（任意）
- `category`: カテゴリ（任意）
- `page`: ページ番号（デフォルト: 1）
- `limit`: 取得件数（デフォルト: 20）

**レスポンス**
```json
{
  "success": true,
  "data": {
    "articles": [
      {
        "article_id": "string",
        "title": "string",
        "category": "string",
        "approval_group_id": "uuid",
        "last_updated": "datetime"
      }
    ],
    "pagination": {
      "current_page": 1,
      "total_pages": 5,
      "total_count": 100
    }
  }
}
```

### 3.3 提案API

#### POST /api/proposals
**リクエスト**
```json
{
  "article_id": "string",
  "type": "修正|削除",
  "title": "string",
  "info_category_id": "uuid",
  "keywords": "string",
  "importance": boolean,
  "published_start": "date",
  "published_end": "date",
  "target": "社内向け|社外向け|該当なし",
  "question": "string",
  "answer": "string",
  "add_comments": "string",
  "reason": "string"
}
```

#### GET /api/proposals
**パラメータ**
- `user_id`: ユーザーID（任意、管理者・SV用）
- `status`: 状況（任意）
- `type`: 提案タイプ（任意）
- `page`: ページ番号

#### PUT /api/proposals/{id}/approve
**リクエスト**
```json
{
  "comment": "string"
}
```

#### PUT /api/proposals/{id}/reject
**リクエスト**
```json
{
  "reason": "string"
}
```

### 3.4 統計API

#### GET /api/statistics/personal
**パラメータ**
- `user_id`: ユーザーID
- `period`: 期間（month/quarter/year）
- `start_date`: 開始日
- `end_date`: 終了日

#### GET /api/statistics/overall
**パラメータ**（管理者のみ）
- `group_by`: グループ化（department/group/user）
- `period`: 期間

## 4. 非機能要件

### 4.1 性能要件
- **レスポンス時間**
  - 画面表示: 3秒以内
  - 検索処理: 5秒以内
  - 承認処理: 2秒以内
  - API応答: 1秒以内

- **スループット**
  - 同時接続数: 50ユーザー
  - ピーク時処理: 100リクエスト/分

### 4.2 可用性要件
- **稼働時間**: 平日 8:00-20:00（99%以上）
- **計画停止**: 土日祝日のメンテナンス時間
- **障害復旧**: 4時間以内

### 4.3 セキュリティ要件

#### 4.3.1 認証・認可
- **パスワードポリシー**
  - 最小8文字、英数字記号組み合わせ
  - bcryptによるハッシュ化（ソルト付き）
  - パスワード有効期限: 90日

- **セッション管理**
  - JWT Token使用
  - Token有効期限: 2時間
  - リフレッシュトークン対応

#### 4.3.2 入力値検証
- **XSS対策**: HTMLエスケープ処理
- **SQLインジェクション対策**: パラメータ化クエリ
- **CSRF対策**: CSRFトークン使用

#### 4.3.3 通信セキュリティ
- **HTTPS通信**: TLS 1.2以上
- **API認証**: Bearer Token
- **CORS設定**: 許可オリジンの制限

### 4.4 データ整合性
- **トランザクション管理**: ACID特性保証
- **外部キー制約**: 参照整合性確保
- **バックアップ**: 日次自動バックアップ
- **データ保持**: 提案データ無期限、ログ6ヶ月

## 5. システム構成

### 5.1 技術スタック

#### 5.1.1 推奨構成
- **フロントエンド**: React 18 + TypeScript
- **バックエンド**: Node.js + Express / Python Django / Java Spring Boot
- **データベース**: PostgreSQL 14+
- **認証**: JWT + bcrypt
- **API**: RESTful API

#### 5.1.2 インフラ構成
- **Webサーバー**: Nginx
- **アプリケーションサーバー**: 選択した技術に応じて
- **データベースサーバー**: PostgreSQL
- **ロードバランサー**: 必要に応じて
- **SSL証明書**: Let's Encrypt / 商用証明書

### 5.2 開発環境
- **バージョン管理**: Git
- **コードレビュー**: Pull Request
- **CI/CD**: GitHub Actions / GitLab CI
- **テスト**: 単体テスト、統合テスト、E2Eテスト

### 5.3 本番環境
- **OS**: Linux (Ubuntu 20.04 LTS / CentOS 8)
- **監視**: ログ監視、性能監視
- **バックアップ**: 自動バックアップ + 手動バックアップ

## 6. 運用要件

### 6.1 システム運用
- **稼働監視**: 24時間監視（平日のみ）
- **ログ管理**: アクセスログ、エラーログ、監査ログ
- **性能監視**: CPU、メモリ、ディスク使用率

### 6.2 メンテナンス
- **定期メンテナンス**: 月次（第2土曜日）
- **緊急メンテナンス**: 障害対応時
- **アップデート**: セキュリティパッチ適用

### 6.3 サポート体制
- **ヘルプデスク**: 社内IT部門
- **対応時間**: 平日 9:00-17:00
- **エスカレーション**: 重要度に応じた対応

## 7. テスト仕様

### 7.1 テスト種別
- **単体テスト**: 各機能の個別テスト（カバレッジ80%以上）
- **統合テスト**: API連携、データベース連携テスト
- **システムテスト**: エンドツーエンドテスト
- **ユーザビリティテスト**: 実ユーザーによる操作性確認
- **負荷テスト**: 性能要件の確認
- **セキュリティテスト**: 脆弱性スキャン

### 7.2 テスト環境
- **開発環境**: 開発者個別環境
- **統合テスト環境**: 本番同等環境
- **ユーザーテスト環境**: 本番同等環境

### 7.3 テストデータ
- **マスタデータ**: 本番同等のテストデータ
- **テストユーザー**: 各役割のテストアカウント
- **テスト記事**: Dynamics365テスト環境との連携

## 8. 移行・導入計画

### 8.1 段階的導入
1. **パイロット導入**: 特定部署での先行導入
2. **部分展開**: 段階的な部署展開
3. **全社展開**: 全社員への展開

### 8.2 ユーザー研修
- **管理者研修**: システム管理機能の説明
- **SV研修**: 承認機能の操作方法
- **一般ユーザー研修**: 基本機能の操作方法
- **マニュアル整備**: 操作マニュアル、FAQ

### 8.3 並行運用
- **並行期間**: 1ヶ月程度
- **既存システム**: 段階的に利用停止
- **データ移行**: 必要に応じて既存データの取り込み

## 9. 今後の拡張計画

### 9.1 機能拡張
- **通知機能**: メール通知、プッシュ通知
- **ワークフロー機能**: 複数段階承認
- **API連携**: 他システムとの連携
- **モバイルアプリ**: スマートフォンアプリ版

### 9.2 技術拡張
- **マイクロサービス化**: サービス分割
- **クラウド移行**: AWS/Azure対応
- **AI機能**: 自動分類、レコメンド機能

### 9.3 運用拡張
- **多言語対応**: 英語版の提供
- **権限細分化**: より詳細な権限管理
- **監査機能**: 操作ログの詳細管理
